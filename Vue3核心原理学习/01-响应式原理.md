# Vue3 å“åº”å¼åŸç† - ä»é›¶å¼€å§‹ç†è§£

> æŠŠä½ å½“æˆå®Œå…¨çš„å°ç™½ï¼Œä¸€æ­¥æ­¥å¸¦ä½ ç†è§£ Vue3 æœ€æ ¸å¿ƒçš„å“åº”å¼ç³»ç»Ÿ

## ğŸ¤” ä»€ä¹ˆæ˜¯"å“åº”å¼"ï¼Ÿ

### å…ˆçœ‹ä¸€ä¸ªé—®é¢˜

å‡è®¾æˆ‘ä»¬æœ‰è¿™æ ·çš„ä»£ç ï¼š

```javascript
let price = 10;
let quantity = 2;
let total = price * quantity;

console.log(total); // 20

// ç°åœ¨æˆ‘æ”¹å˜ price
price = 20;

console.log(total); // è¿˜æ˜¯ 20ï¼ä¸æ˜¯ 40ï¼
```

**é—®é¢˜**ï¼šJavaScript æ˜¯"ä¸€æ¬¡æ€§æ‰§è¡Œ"çš„ï¼Œ`total = price * quantity` æ‰§è¡Œå®Œå°±ç»“æŸäº†ã€‚ä¹‹åä½ æ”¹ `price`ï¼Œ`total` ä¸ä¼šè‡ªåŠ¨æ›´æ–°ã€‚

### ä»€ä¹ˆæ˜¯å“åº”å¼ï¼Ÿ

**å“åº”å¼ = æ•°æ®å˜äº†ï¼Œä¾èµ–è¿™ä¸ªæ•°æ®çš„åœ°æ–¹è‡ªåŠ¨æ›´æ–°**

å°±åƒ Excel è¡¨æ ¼ï¼š

- A1 = 10
- A2 = 2
- A3 = A1 \* A2 = 20
- å½“ä½ æ”¹ A1 = 20ï¼ŒA3 è‡ªåŠ¨å˜æˆ 40

Vue åšçš„äº‹æƒ…å°±æ˜¯ï¼š**è®© JavaScript ä¹Ÿèƒ½åƒ Excel ä¸€æ ·è‡ªåŠ¨æ›´æ–°ï¼**

---

## ğŸ¯ ç¬¬ä¸€æ­¥ï¼šå¦‚ä½•çŸ¥é“æ•°æ®è¢«"è¯»å–"å’Œ"ä¿®æ”¹"äº†ï¼Ÿ

è¦å®ç°å“åº”å¼ï¼Œé¦–å…ˆè¦è§£å†³ï¼š**æ€ä¹ˆçŸ¥é“æ•°æ®è¢«è®¿é—®äº†ï¼Ÿæ€ä¹ˆçŸ¥é“æ•°æ®è¢«ä¿®æ”¹äº†ï¼Ÿ**

### JavaScript çš„"æ‹¦æˆªå™¨" - Proxy

ES6 æä¾›äº† `Proxy`ï¼Œå¯ä»¥"æ‹¦æˆª"å¯¹è±¡çš„è¯»å†™æ“ä½œï¼š

```javascript
// åŸå§‹å¯¹è±¡
const data = { price: 10, quantity: 2 };

// ç”¨ Proxy åŒ…è£…ï¼Œåˆ›å»ºä»£ç†å¯¹è±¡
const proxy = new Proxy(data, {
  // æ‹¦æˆª"è¯»å–"æ“ä½œ
  get(target, key) {
    console.log(`ğŸ” æœ‰äººè¯»å–äº† ${key}`);
    return target[key];
  },

  // æ‹¦æˆª"ä¿®æ”¹"æ“ä½œ
  set(target, key, value) {
    console.log(`âœï¸ æœ‰äººä¿®æ”¹äº† ${key}ï¼Œæ–°å€¼æ˜¯ ${value}`);
    target[key] = value;
    return true;
  },
});

// æµ‹è¯•ä¸€ä¸‹
proxy.price; // ğŸ” æœ‰äººè¯»å–äº† price
proxy.price = 20; // âœï¸ æœ‰äººä¿®æ”¹äº† priceï¼Œæ–°å€¼æ˜¯ 20
```

**å…³é”®ç†è§£**ï¼š

- `Proxy` å°±åƒä¸€ä¸ª"é—¨å«"ï¼Œå®ˆåœ¨æ•°æ®é—¨å£
- ä»»ä½•äººæƒ³è¯»æ•°æ®ï¼Œé—¨å«çŸ¥é“
- ä»»ä½•äººæƒ³æ”¹æ•°æ®ï¼Œé—¨å«ä¹ŸçŸ¥é“

---

## ğŸ¯ ç¬¬äºŒæ­¥ï¼šè®°ä½"è°ä¾èµ–äº†è¿™ä¸ªæ•°æ®"

ç°åœ¨æˆ‘ä»¬èƒ½æ‹¦æˆªè¯»å†™äº†ï¼Œä¸‹ä¸€æ­¥ï¼š**å½“æ•°æ®è¢«è¯»å–æ—¶ï¼Œè®°ä½æ˜¯è°åœ¨è¯»ï¼ˆæ”¶é›†ä¾èµ–ï¼‰**

### ä¾èµ–æ”¶é›†çš„æ¦‚å¿µ

```javascript
// å‡è®¾æœ‰ä¸€ä¸ªè®¡ç®— total çš„å‡½æ•°
function updateTotal() {
  total = proxy.price * proxy.quantity;
  console.log("total æ›´æ–°äº†:", total);
}

// å½“ updateTotal æ‰§è¡Œæ—¶ï¼š
// 1. è¯»å–äº† proxy.price â†’ price è¦è®°ä½ï¼šupdateTotal ä¾èµ–æˆ‘
// 2. è¯»å–äº† proxy.quantity â†’ quantity è¦è®°ä½ï¼šupdateTotal ä¾èµ–æˆ‘
```

### å®ç°ä¾èµ–æ”¶é›†

```javascript
// å­˜å‚¨ä¾èµ–å…³ç³»çš„"ä»“åº“"
// ç»“æ„ï¼š{ price: [effect1, effect2], quantity: [effect3] }
const targetMap = new WeakMap();

// å½“å‰æ­£åœ¨æ‰§è¡Œçš„å‰¯ä½œç”¨å‡½æ•°
let activeEffect = null;

// æ”¶é›†ä¾èµ–
function track(target, key) {
  if (!activeEffect) return;

  // è·å–è¿™ä¸ªå¯¹è±¡çš„ä¾èµ– Map
  let depsMap = targetMap.get(target);
  if (!depsMap) {
    depsMap = new Map();
    targetMap.set(target, depsMap);
  }

  // è·å–è¿™ä¸ª key çš„ä¾èµ– Set
  let deps = depsMap.get(key);
  if (!deps) {
    deps = new Set();
    depsMap.set(key, deps);
  }

  // æŠŠå½“å‰çš„ effect åŠ å…¥ä¾èµ–
  deps.add(activeEffect);
  console.log(`ğŸ“ ${key} æ”¶é›†äº†ä¸€ä¸ªä¾èµ–`);
}

// è§¦å‘æ›´æ–°
function trigger(target, key) {
  const depsMap = targetMap.get(target);
  if (!depsMap) return;

  const deps = depsMap.get(key);
  if (deps) {
    deps.forEach((effect) => {
      console.log(`ğŸ”„ ${key} å˜äº†ï¼Œè§¦å‘æ›´æ–°`);
      effect();
    });
  }
}
```

---

## ğŸ¯ ç¬¬ä¸‰æ­¥ï¼šå®Œæ•´å®ç°ä¸€ä¸ªè¿·ä½ å“åº”å¼ç³»ç»Ÿ

è®©æˆ‘ä»¬æŠŠæ‰€æœ‰ä¸œè¥¿ç»„åˆèµ·æ¥ï¼š

```javascript
// ========== å“åº”å¼æ ¸å¿ƒ ==========

const targetMap = new WeakMap();
let activeEffect = null;

// æ”¶é›†ä¾èµ–
function track(target, key) {
  if (!activeEffect) return;

  let depsMap = targetMap.get(target);
  if (!depsMap) {
    depsMap = new Map();
    targetMap.set(target, depsMap);
  }

  let deps = depsMap.get(key);
  if (!deps) {
    deps = new Set();
    depsMap.set(key, deps);
  }

  deps.add(activeEffect);
}

// è§¦å‘æ›´æ–°
function trigger(target, key) {
  const depsMap = targetMap.get(target);
  if (!depsMap) return;

  const deps = depsMap.get(key);
  if (deps) {
    deps.forEach((effect) => effect());
  }
}

// åˆ›å»ºå“åº”å¼å¯¹è±¡ï¼ˆVue3 çš„ reactiveï¼‰
function reactive(target) {
  return new Proxy(target, {
    get(target, key, receiver) {
      const result = Reflect.get(target, key, receiver);
      track(target, key); // æ”¶é›†ä¾èµ–
      return result;
    },
    set(target, key, value, receiver) {
      const result = Reflect.set(target, key, value, receiver);
      trigger(target, key); // è§¦å‘æ›´æ–°
      return result;
    },
  });
}

// æ³¨å†Œå‰¯ä½œç”¨å‡½æ•°ï¼ˆVue3 çš„ watchEffectï¼‰
function effect(fn) {
  activeEffect = fn;
  fn(); // ç«‹å³æ‰§è¡Œä¸€æ¬¡ï¼Œè§¦å‘ä¾èµ–æ”¶é›†
  activeEffect = null;
}

// ========== æµ‹è¯• ==========

// åˆ›å»ºå“åº”å¼æ•°æ®
const state = reactive({
  price: 10,
  quantity: 2,
});

let total = 0;

// æ³¨å†Œä¸€ä¸ªå‰¯ä½œç”¨
effect(() => {
  total = state.price * state.quantity;
  console.log(`âœ¨ total æ›´æ–°äº†: ${total}`);
});

// è¾“å‡º: âœ¨ total æ›´æ–°äº†: 20

// ä¿®æ”¹æ•°æ®ï¼Œè‡ªåŠ¨è§¦å‘æ›´æ–°ï¼
state.price = 20;
// è¾“å‡º: âœ¨ total æ›´æ–°äº†: 40

state.quantity = 5;
// è¾“å‡º: âœ¨ total æ›´æ–°äº†: 100
```

ğŸ‰ **æ­å–œï¼ä½ å·²ç»ç†è§£äº† Vue3 å“åº”å¼çš„æ ¸å¿ƒåŸç†ï¼**

---

## ğŸ” ç”¨å›¾æ¥ç†è§£æ•´ä¸ªæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å“åº”å¼æµç¨‹å›¾                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   1. åˆ›å»ºå“åº”å¼å¯¹è±¡                                               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚   â”‚ reactive(data)   â”‚ â”€â”€â†’ è¿”å› Proxy ä»£ç†å¯¹è±¡                   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚                                                                 â”‚
â”‚   2. æ³¨å†Œå‰¯ä½œç”¨å‡½æ•°                                               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚   â”‚ effect(() => {   â”‚                                          â”‚
â”‚   â”‚   total = a + b  â”‚ â”€â”€â†’ æ‰§è¡Œå‡½æ•°ï¼Œè§¦å‘ get                    â”‚
â”‚   â”‚ })               â”‚                                          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚            â”‚                                                    â”‚
â”‚            â–¼                                                    â”‚
â”‚   3. ä¾èµ–æ”¶é›†ï¼ˆget è§¦å‘ï¼‰                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚   â”‚ track(target,key)â”‚ â”€â”€â†’  â”‚ targetMap å­˜å‚¨ä¾èµ–   â”‚            â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ { a: [effect1],     â”‚            â”‚
â”‚                             â”‚   b: [effect1] }    â”‚            â”‚
â”‚                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                 â”‚
â”‚   4. æ•°æ®ä¿®æ”¹ï¼ˆset è§¦å‘ï¼‰                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚   â”‚ state.a = 100    â”‚ â”€â”€â†’ è§¦å‘ set                             â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚            â”‚                                                    â”‚
â”‚            â–¼                                                    â”‚
â”‚   5. è§¦å‘æ›´æ–°                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚   â”‚trigger(target,key)â”‚ â”€â”€â†’ â”‚ æ‰¾åˆ° a çš„æ‰€æœ‰ä¾èµ–    â”‚            â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ æ‰§è¡Œ effect1()      â”‚            â”‚
â”‚                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ Vue3 çœŸå® API å¯¹ç…§

| æˆ‘ä»¬å®ç°çš„   | Vue3 çœŸå® API   | ä½œç”¨           |
| ------------ | --------------- | -------------- |
| `reactive()` | `reactive()`    | åˆ›å»ºå“åº”å¼å¯¹è±¡ |
| `effect()`   | `watchEffect()` | æ³¨å†Œå‰¯ä½œç”¨å‡½æ•° |
| `track()`    | å†…éƒ¨å‡½æ•°        | æ”¶é›†ä¾èµ–       |
| `trigger()`  | å†…éƒ¨å‡½æ•°        | è§¦å‘æ›´æ–°       |

---

## ğŸ¤” ä¸ºä»€ä¹ˆ Vue3 ç”¨ Proxy è€Œä¸ç”¨ Vue2 çš„ Object.definePropertyï¼Ÿ

### Vue2 çš„é—®é¢˜

```javascript
// Vue2 ç”¨ Object.defineProperty
Object.defineProperty(data, "price", {
  get() {
    /* ... */
  },
  set() {
    /* ... */
  },
});

// âŒ é—®é¢˜1ï¼šå¿…é¡»æå‰çŸ¥é“æœ‰å“ªäº›å±æ€§
data.newProp = 123; // æ–°å¢å±æ€§æ— æ³•ç›‘å¬ï¼

// âŒ é—®é¢˜2ï¼šæ•°ç»„çš„é—®é¢˜
data.arr[0] = "new"; // æ•°ç»„ç´¢å¼•ä¿®æ”¹æ— æ³•ç›‘å¬ï¼
data.arr.length = 0; // é•¿åº¦ä¿®æ”¹æ— æ³•ç›‘å¬ï¼
```

### Vue3 çš„ Proxy ä¼˜åŠ¿

```javascript
// Vue3 ç”¨ Proxy
const proxy = new Proxy(data, {
  get(target, key) {
    /* ... */
  },
  set(target, key, value) {
    /* ... */
  },
});

// âœ… æ–°å¢å±æ€§å¯ä»¥ç›‘å¬
proxy.newProp = 123; // æ­£å¸¸è§¦å‘ set

// âœ… æ•°ç»„æ“ä½œå¯ä»¥ç›‘å¬
proxy.arr[0] = "new"; // æ­£å¸¸è§¦å‘ set
proxy.arr.push("item"); // æ­£å¸¸è§¦å‘
```

---

## ğŸ“ å°ç»“

1. **å“åº”å¼çš„æœ¬è´¨**ï¼šæ•°æ®å˜åŒ– â†’ è‡ªåŠ¨æ›´æ–°è§†å›¾
2. **æ ¸å¿ƒæŠ€æœ¯**ï¼šProxy æ‹¦æˆªå¯¹è±¡çš„ get/set
3. **ä¾èµ–æ”¶é›†**ï¼šè¯»å–æ•°æ®æ—¶ï¼Œè®°ä½è°åœ¨è¯»ï¼ˆtrackï¼‰
4. **è§¦å‘æ›´æ–°**ï¼šä¿®æ”¹æ•°æ®æ—¶ï¼Œé€šçŸ¥æ‰€æœ‰ä¾èµ–æ›´æ–°ï¼ˆtriggerï¼‰

---

## ğŸš€ ä¸‹ä¸€æ­¥å­¦ä¹ 

- [02-ref ä¸ reactive çš„åŒºåˆ«](./02-refä¸reactive.md)
- [03-computed è®¡ç®—å±æ€§åŸç†](./03-computedåŸç†.md)
- [04-watch ä¾¦å¬å™¨åŸç†](./04-watchåŸç†.md)

---

## ğŸ’» åŠ¨æ‰‹ç»ƒä¹ 

åˆ›å»ºä¸€ä¸ª HTML æ–‡ä»¶ï¼ŒæŠŠä¸Šé¢çš„ä»£ç å¤åˆ¶è¿›å»è¿è¡Œè¯•è¯•ï¼š

```html
<!DOCTYPE html>
<html>
  <head>
    <title>Vue3 å“åº”å¼åŸç†ç»ƒä¹ </title>
  </head>
  <body>
    <h1>æ‰“å¼€æ§åˆ¶å°æŸ¥çœ‹è¾“å‡º</h1>
    <script>
      // æŠŠä¸Šé¢çš„å®Œæ•´ä»£ç å¤åˆ¶åˆ°è¿™é‡Œ
      // ç„¶ååœ¨æ§åˆ¶å°ä¿®æ”¹ state.price çœ‹çœ‹æ•ˆæœ
    </script>
  </body>
</html>
```
