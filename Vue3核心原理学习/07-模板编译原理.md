# æ¨¡æ¿ç¼–è¯‘åŸç†

> ç†è§£ Vue3 å¦‚ä½•æŠŠ template å˜æˆ render å‡½æ•°

## ğŸ¤” ä¸ºä»€ä¹ˆéœ€è¦ç¼–è¯‘ï¼Ÿ

Vue å…è®¸ä½ ç”¨ template å†™ç»„ä»¶ï¼š

```vue
<template>
  <div>
    <p>{{ message }}</p>
    <button @click="handleClick">ç‚¹å‡»</button>
  </div>
</template>
```

ä½†æµè§ˆå™¨ä¸è®¤è¯†è¿™ä¸ªè¯­æ³•ï¼éœ€è¦**ç¼–è¯‘**æˆ JavaScriptï¼š

```javascript
function render() {
  return h('div', null, [
    h('p', null, this.message),
    h('button', { onClick: this.handleClick }, 'ç‚¹å‡»')
  ])
}
```

---

## ğŸ”„ ç¼–è¯‘çš„ä¸‰ä¸ªé˜¶æ®µ

```
Template (æ¨¡æ¿å­—ç¬¦ä¸²)
    â†“
  Parse (è§£æ)
    â†“
AST (æŠ½è±¡è¯­æ³•æ ‘)
    â†“
Transform (è½¬æ¢)
    â†“
JavaScript AST
    â†“
Generate (ç”Ÿæˆ)
    â†“
Render Function (æ¸²æŸ“å‡½æ•°ä»£ç )
```

---

## ğŸ¯ ç¬¬ä¸€é˜¶æ®µï¼šParse è§£æ

### æŠŠæ¨¡æ¿å­—ç¬¦ä¸²è§£ææˆ AST

```javascript
// è¾“å…¥ï¼šæ¨¡æ¿å­—ç¬¦ä¸²
const template = `<div><p>{{ message }}</p></div>`

// è¾“å‡ºï¼šASTï¼ˆæŠ½è±¡è¯­æ³•æ ‘ï¼‰
const ast = {
  type: 'Root',
  children: [
    {
      type: 'Element',
      tag: 'div',
      children: [
        {
          type: 'Element',
          tag: 'p',
          children: [
            {
              type: 'Interpolation',  // æ’å€¼
              content: {
                type: 'SimpleExpression',
                content: 'message'
              }
            }
          ]
        }
      ]
    }
  ]
}
```

### ç®€åŒ–ç‰ˆè§£æå™¨

```javascript
// çŠ¶æ€æœºè§£æ HTML
function parse(template) {
  const context = {
    source: template,  // å‰©ä½™å¾…è§£æçš„æ¨¡æ¿
    // ...
  }
  
  return parseChildren(context)
}

function parseChildren(context) {
  const nodes = []
  
  while (!isEnd(context)) {
    let node
    const s = context.source
    
    if (s.startsWith('{{')) {
      // è§£ææ’å€¼ {{ xxx }}
      node = parseInterpolation(context)
    } else if (s[0] === '<') {
      if (s[1] === '/') {
        // ç»“æŸæ ‡ç­¾ </div>
        // ...
      } else if (/[a-z]/i.test(s[1])) {
        // å¼€å§‹æ ‡ç­¾ <div>
        node = parseElement(context)
      }
    } else {
      // æ–‡æœ¬èŠ‚ç‚¹
      node = parseText(context)
    }
    
    nodes.push(node)
  }
  
  return nodes
}

// è§£æå…ƒç´ 
function parseElement(context) {
  // è§£æå¼€å§‹æ ‡ç­¾ <div class="foo">
  const element = parseTag(context)
  
  // é€’å½’è§£æå­èŠ‚ç‚¹
  element.children = parseChildren(context)
  
  // è§£æç»“æŸæ ‡ç­¾ </div>
  parseTag(context, 'end')
  
  return element
}

// è§£ææ’å€¼ {{ message }}
function parseInterpolation(context) {
  // æ¶ˆè´¹ {{
  advanceBy(context, 2)
  
  // æ‰¾åˆ° }}
  const closeIndex = context.source.indexOf('}}')
  
  // æå–è¡¨è¾¾å¼å†…å®¹
  const content = context.source.slice(0, closeIndex).trim()
  
  // æ¶ˆè´¹ è¡¨è¾¾å¼ + }}
  advanceBy(context, closeIndex + 2)
  
  return {
    type: 'Interpolation',
    content: {
      type: 'SimpleExpression',
      content
    }
  }
}
```

---

## ğŸ¯ ç¬¬äºŒé˜¶æ®µï¼šTransform è½¬æ¢

### å¯¹ AST è¿›è¡Œè½¬æ¢å’Œä¼˜åŒ–

```javascript
// è½¬æ¢å‰ï¼šæ¨¡æ¿ AST
{
  type: 'Element',
  tag: 'div',
  children: [...]
}

// è½¬æ¢åï¼šJavaScript AST
{
  type: 'VNodeCall',
  tag: '"div"',
  props: null,
  children: [...]
}
```

### ä¸»è¦è½¬æ¢å†…å®¹

1. **é™æ€æå‡**ï¼šæ ‡è®°é™æ€èŠ‚ç‚¹
2. **v-if/v-for è½¬æ¢**ï¼šè½¬æˆæ¡ä»¶/å¾ªç¯è¡¨è¾¾å¼
3. **äº‹ä»¶å¤„ç†**ï¼š@click è½¬æˆ onClick
4. **v-model è½¬æ¢**ï¼šåŒå‘ç»‘å®šè¯­æ³•ç³–

### ç®€åŒ–ç‰ˆè½¬æ¢å™¨

```javascript
function transform(ast) {
  const context = {
    currentNode: ast,
    parent: null,
    // èŠ‚ç‚¹è½¬æ¢å‡½æ•°
    nodeTransforms: [
      transformElement,
      transformText,
      transformInterpolation
    ]
  }
  
  traverseNode(ast, context)
}

function traverseNode(node, context) {
  context.currentNode = node
  
  // æ‰§è¡Œæ‰€æœ‰è½¬æ¢
  const transforms = context.nodeTransforms
  for (let i = 0; i < transforms.length; i++) {
    transforms[i](node, context)
  }
  
  // é€’å½’å¤„ç†å­èŠ‚ç‚¹
  if (node.children) {
    for (let i = 0; i < node.children.length; i++) {
      context.parent = node
      traverseNode(node.children[i], context)
    }
  }
}

// è½¬æ¢å…ƒç´ èŠ‚ç‚¹
function transformElement(node, context) {
  if (node.type !== 'Element') return
  
  // è¿”å›ä¸€ä¸ªé€€å‡ºå‡½æ•°ï¼Œåœ¨å­èŠ‚ç‚¹å¤„ç†å®Œåæ‰§è¡Œ
  return () => {
    // ç”Ÿæˆ VNodeCall
    node.codegenNode = {
      type: 'VNodeCall',
      tag: `"${node.tag}"`,
      props: buildProps(node),
      children: buildChildren(node)
    }
  }
}
```

---

## ğŸ¯ ç¬¬ä¸‰é˜¶æ®µï¼šGenerate ä»£ç ç”Ÿæˆ

### æŠŠ JS AST ç”Ÿæˆä»£ç å­—ç¬¦ä¸²

```javascript
// è¾“å…¥ï¼šJS AST
{
  type: 'VNodeCall',
  tag: '"div"',
  props: null,
  children: [
    {
      type: 'VNodeCall',
      tag: '"p"',
      children: [{ type: 'Interpolation', content: 'message' }]
    }
  ]
}

// è¾“å‡ºï¼šä»£ç å­—ç¬¦ä¸²
`function render(_ctx) {
  return _createVNode("div", null, [
    _createVNode("p", null, _toDisplayString(_ctx.message))
  ])
}`
```

### ç®€åŒ–ç‰ˆä»£ç ç”Ÿæˆå™¨

```javascript
function generate(ast) {
  const context = {
    code: '',        // ç”Ÿæˆçš„ä»£ç 
    indentLevel: 0,  // ç¼©è¿›çº§åˆ«
    
    push(code) {
      context.code += code
    },
    indent() {
      context.indentLevel++
    },
    deindent() {
      context.indentLevel--
    },
    newline() {
      context.code += '\n' + '  '.repeat(context.indentLevel)
    }
  }
  
  // ç”Ÿæˆå‡½æ•°å£°æ˜
  context.push('function render(_ctx) {')
  context.indent()
  context.newline()
  context.push('return ')
  
  // ç”Ÿæˆä¸»ä½“ä»£ç 
  genNode(ast.codegenNode, context)
  
  context.deindent()
  context.newline()
  context.push('}')
  
  return context.code
}

function genNode(node, context) {
  switch (node.type) {
    case 'VNodeCall':
      genVNodeCall(node, context)
      break
    case 'Text':
      genText(node, context)
      break
    case 'Interpolation':
      genInterpolation(node, context)
      break
    // ...
  }
}

function genVNodeCall(node, context) {
  const { push } = context
  const { tag, props, children } = node
  
  push(`_createVNode(${tag}`)
  
  if (props) {
    push(', ')
    genNode(props, context)
  } else if (children) {
    push(', null')
  }
  
  if (children) {
    push(', ')
    if (Array.isArray(children)) {
      push('[')
      children.forEach((child, i) => {
        if (i > 0) push(', ')
        genNode(child, context)
      })
      push(']')
    } else {
      genNode(children, context)
    }
  }
  
  push(')')
}
```

---

## ğŸ” ç¼–è¯‘ä¼˜åŒ–

### 1. é™æ€æå‡ (Static Hoisting)

```vue
<template>
  <div>
    <p>é™æ€æ–‡æœ¬</p>  <!-- æ°¸è¿œä¸å˜ -->
    <p>{{ dynamic }}</p>
  </div>
</template>
```

ç¼–è¯‘ç»“æœï¼š

```javascript
// é™æ€èŠ‚ç‚¹è¢«æå‡åˆ° render å‡½æ•°å¤–
const _hoisted_1 = _createVNode("p", null, "é™æ€æ–‡æœ¬")

function render(_ctx) {
  return _createVNode("div", null, [
    _hoisted_1,  // å¤ç”¨ï¼Œä¸é‡æ–°åˆ›å»º
    _createVNode("p", null, _toDisplayString(_ctx.dynamic))
  ])
}
```

### 2. è¡¥ä¸æ ‡å¿— (Patch Flags)

```vue
<template>
  <div :id="id" class="static">{{ text }}</div>
</template>
```

ç¼–è¯‘ç»“æœï¼š

```javascript
_createVNode("div", {
  id: _ctx.id,
  class: "static"
}, _toDisplayString(_ctx.text), 
  1 /* TEXT */ | 2 /* PROPS */,  // è¡¥ä¸æ ‡å¿—
  ["id"]  // åŠ¨æ€å±æ€§åˆ—è¡¨
)
```

è¡¥ä¸æ ‡å¿—å‘Šè¯‰ Diffï¼š
- `1 (TEXT)`ï¼šæ–‡æœ¬æ˜¯åŠ¨æ€çš„
- `2 (PROPS)`ï¼šæœ‰åŠ¨æ€å±æ€§ï¼Œåªéœ€æ£€æŸ¥ `id`

### 3. Block Tree

```vue
<template>
  <div>  <!-- Block -->
    <span>static</span>
    <span>{{ dynamic1 }}</span>
    <div v-if="ok">  <!-- Block -->
      <span>{{ dynamic2 }}</span>
    </div>
  </div>
</template>
```

Block ä¼šæ”¶é›†æ‰€æœ‰åŠ¨æ€å­å­™èŠ‚ç‚¹ï¼š

```javascript
// å¤–å±‚ Block
{
  type: 'div',
  dynamicChildren: [
    { type: 'span', children: dynamic1 },
    // v-if Block (å¦‚æœ ok ä¸º true)
    { type: 'div', dynamicChildren: [...] }
  ]
}
```

Diff æ—¶ç›´æ¥éå† `dynamicChildren`ï¼Œè·³è¿‡é™æ€èŠ‚ç‚¹ï¼

---

## ğŸ“Š ç¼–è¯‘æ—¶ vs è¿è¡Œæ—¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Vue3 ç¼–è¯‘æµç¨‹                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  å¼€å‘æ—¶ï¼ˆæ„å»ºå·¥å…·ï¼‰                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚  â”‚ .vue æ–‡ä»¶                        â”‚                           â”‚
â”‚  â”‚    â†“                             â”‚                           â”‚
â”‚  â”‚ @vue/compiler-sfc                â”‚                           â”‚
â”‚  â”‚    â†“                             â”‚                           â”‚
â”‚  â”‚ ç¼–è¯‘ template â†’ render å‡½æ•°      â”‚                           â”‚
â”‚  â”‚ ç¼–è¯‘ style â†’ CSS                 â”‚                           â”‚
â”‚  â”‚    â†“                             â”‚                           â”‚
â”‚  â”‚ è¾“å‡º JavaScript æ¨¡å—             â”‚                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                                                                 â”‚
â”‚  è¿è¡Œæ—¶ï¼ˆæµè§ˆå™¨ï¼‰                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚  â”‚ ç›´æ¥æ‰§è¡Œç¼–è¯‘å¥½çš„ render å‡½æ•°     â”‚                           â”‚
â”‚  â”‚ ä¸éœ€è¦ç¼–è¯‘å™¨ï¼                   â”‚                           â”‚
â”‚  â”‚    â†“                             â”‚                           â”‚
â”‚  â”‚ vue.runtime.esm.js (æ›´å°)        â”‚                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Vue3 åŒ…çš„åŒºåˆ«

| åŒ… | å¤§å° | ç”¨é€” |
|---|-----|------|
| `vue.esm.js` | å®Œæ•´ç‰ˆ | åŒ…å«ç¼–è¯‘å™¨ï¼Œå¯ä»¥è¿è¡Œæ—¶ç¼–è¯‘ |
| `vue.runtime.esm.js` | è¿è¡Œæ—¶ç‰ˆ | ä¸å«ç¼–è¯‘å™¨ï¼Œæ›´å° |

**æ¨è**ï¼šä½¿ç”¨æ„å»ºå·¥å…·ï¼ˆVite/Webpackï¼‰ï¼Œé¢„ç¼–è¯‘ templateï¼Œåªå¼•å…¥è¿è¡Œæ—¶ç‰ˆã€‚

---

## ğŸ› ï¸ å®é™…æŸ¥çœ‹ç¼–è¯‘ç»“æœ

### æ–¹æ³•1ï¼šVue SFC Playground

è®¿é—® https://play.vuejs.org/

å¯ä»¥å®æ—¶æŸ¥çœ‹ template ç¼–è¯‘æˆçš„ render å‡½æ•°ï¼

### æ–¹æ³•2ï¼šåœ¨é¡¹ç›®ä¸­æŸ¥çœ‹

```javascript
// vite.config.js
export default {
  vue: {
    // è¾“å‡ºç¼–è¯‘åçš„ä»£ç 
    reactivityTransform: true
  }
}
```

---

## ğŸ“ æŒ‡ä»¤çš„ç¼–è¯‘

### v-if

```vue
<template>
  <div v-if="show">Hello</div>
</template>
```

ç¼–è¯‘æˆï¼š

```javascript
function render(_ctx) {
  return _ctx.show
    ? _createVNode("div", null, "Hello")
    : _createCommentVNode("v-if")  // æ³¨é‡ŠèŠ‚ç‚¹å ä½
}
```

### v-for

```vue
<template>
  <li v-for="item in items" :key="item.id">{{ item.name }}</li>
</template>
```

ç¼–è¯‘æˆï¼š

```javascript
function render(_ctx) {
  return _renderList(_ctx.items, (item) => {
    return _createVNode("li", { key: item.id }, item.name)
  })
}
```

### v-model

```vue
<template>
  <input v-model="text" />
</template>
```

ç¼–è¯‘æˆï¼š

```javascript
function render(_ctx) {
  return _createVNode("input", {
    value: _ctx.text,
    onInput: ($event) => { _ctx.text = $event.target.value }
  })
}
```

---

## ğŸ“ æ€»ç»“

| é˜¶æ®µ | è¾“å…¥ | è¾“å‡º | ä½œç”¨ |
|-----|------|------|------|
| **Parse** | æ¨¡æ¿å­—ç¬¦ä¸² | Template AST | è¯æ³•/è¯­æ³•åˆ†æ |
| **Transform** | Template AST | JS AST | è½¬æ¢ + ä¼˜åŒ– |
| **Generate** | JS AST | ä»£ç å­—ç¬¦ä¸² | ç”Ÿæˆ render å‡½æ•° |

### æ ¸å¿ƒä¼˜åŒ–

1. **é™æ€æå‡**ï¼šé™æ€èŠ‚ç‚¹åªåˆ›å»ºä¸€æ¬¡
2. **è¡¥ä¸æ ‡å¿—**ï¼šç²¾ç¡®æ ‡è®°åŠ¨æ€å†…å®¹
3. **Block Tree**ï¼šæ‰å¹³åŒ–æ”¶é›†åŠ¨æ€èŠ‚ç‚¹
4. **é¢„ç¼–è¯‘**ï¼šæ„å»ºæ—¶ç¼–è¯‘ï¼Œè¿è¡Œæ—¶æ›´å¿«

---

## ğŸš€ ä¸‹ä¸€æ­¥

- [08-é¢è¯•é¢˜æ€»ç»“](./08-é¢è¯•é¢˜æ€»ç»“.md)



