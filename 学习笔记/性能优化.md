# Vite 项目性能优化指南

本文档记录了 Vite H5 项目中的性能优化方案和最佳实践。

---

## 📦 资源优化

### 1. 图片压缩

**优化方案：** 利用阿里云 OSS 图片处理服务进行自动压缩

**实现方式：**

- 使用阿里云 OSS 的图片处理参数
- 在图片 URL 后添加压缩参数
- 根据实际需求调整压缩质量

**参考文档：** [阿里云 OSS 图片处理](https://help.aliyun.com/zh/oss/user-guide/overview-17/?spm=a2c4g.11186623.help-menu-31815.d_0_11_2.acbb24a1r2UOkQ)

**优化效果：** 可显著减少图片体积，提升加载速度

---

### 2. 图片懒加载

**优化方案：** 使用 `v-lazyload` 指令实现可视区域懒加载

**技术实现：**

- 基于 `IntersectionObserver API` 实现
- 支持 `<img>` 标签懒加载
- 支持背景图片懒加载
- 只在元素进入视口时才加载图片

**优化效果：** 减少初始加载资源数量，提升首屏加载速度

---

### 3. WebP 格式自动转换

**优化方案：** 智能检测浏览器支持并自动使用 WebP 格式

**实现方式：**

- 自动检测浏览器是否支持 WebP 格式
- 通过阿里云 OSS 参数自动转换：`?x-oss-process=image/format,webp`
- 不支持 WebP 的浏览器回退到原格式

**优化效果：** WebP 格式可减少 **25-35%** 的图片体积

---

### 4. 关键图片预加载

**优化方案：** 使用 `prefetchPic.ts` 插件预加载关键图片

**实现方式：**

- 在客户端环境中提前加载首屏关键图片
- 优先加载可视区域内的重要资源
- 提升用户感知加载速度

**优化效果：** 改善首屏体验，减少白屏时间

---

## 🚀 构建优化

### 5. 代码分割与 CDN 加速

**优化方案：** 将公共依赖包通过 CDN 加载，配合协商缓存

**实现方式：**

- 配置 Vite 的 `build.rollupOptions.external`
- 将 React、Vue 等公共库通过 CDN 引入
- 启用协商缓存策略

**优化效果：**

- 减小主包体积
- 用户访问多个活动页面时，公共资源只需加载一次
- 充分利用浏览器缓存机制

---

### 6. Gzip 压缩

**优化方案：** 开启 Gzip 压缩减少传输体积

**实现方式：**

- 使用 `vite-plugin-compression` 插件
- 配置服务器支持 Gzip

**优化效果：** 一般可压缩 **60-70%** 的文本资源体积

---

### 7. 代码压缩优化

**优化方案：** 使用 Terser 进行代码压缩和清理

**配置选项：**

```javascript
// vite.config.js
build: {
  minify: 'terser',
  terserOptions: {
    compress: {
      drop_console: true,    // 移除 console.log
      drop_debugger: true,   // 移除 debugger
    },
    format: {
      comments: false,       // 移除注释
    }
  },
  cssCodeSplit: false,       // CSS 不分割，减少请求数
}
```

**优化效果：** 减小 JS/CSS 文件体积，提升加载和解析速度

---

## 🔧 兼容性优化

### 8. 浏览器兼容性处理

**优化方案：** 使用 `@vitejs/plugin-legacy` 支持旧版浏览器

**实现方式：**

- 自动为旧版浏览器添加必要的 polyfill
- 构建现代版本和兼容版本两套代码
- 根据浏览器特性自动选择加载版本

**优化效果：** 在保证现代浏览器性能的同时，兼容旧版浏览器

---

## 📊 性能监控建议

- 使用 Lighthouse 进行性能评分
- 监控首屏加载时间（FCP、LCP）
- 关注交互响应时间（FID、TTI）
- 定期检查资源加载瀑布流

---

## 🎯 优化原则

1. **优先优化首屏加载** - 关注用户第一印象
2. **按需加载** - 避免一次性加载所有资源
3. **充分利用缓存** - 减少重复资源加载
4. **持续监控优化** - 定期检查性能指标
